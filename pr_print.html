<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Purchase Requisition - Print</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
body {
  font-family: Tahoma, Arial, sans-serif;
  font-size: 12px;
  margin: 20px;
  color: #000;
}
h2 {
  text-align: center;
  margin-bottom: 10px;
}

/* Header Info */
.header-info table {
  width: 100%;
  margin-bottom: 10px;
  border-collapse: collapse;
}
.header-info td {
  padding: 0;
  vertical-align: top;
}
.header-info .label {
  width: 120px;
  font-weight: bold;
  text-align: left;
}
.header-info .colon {
  width: 10px;
  text-align: center;
}
.header-info .value {
  text-align: left;
}

/* Items Table */
table.items-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
.items-table th, .items-table td {
  border: 1px solid #000;
  padding: 5px;
  font-size: 12px;
}
.items-table th {
  background-color: #eee;
  text-align: center;
}
.items-table td.center, 
.items-table td.required-date {
  text-align: center;
}

/* Description & Signatures */
.description-sign-container {
  display: flex;
  gap: 20px;
  margin-top: 10px;
  align-items: stretch;
}

.description-full {
  flex-basis: calc(50%);
  padding: 10px;
  background-color: #f9f9f9;
  font-style: italic;
  border: 1px solid #000;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.description-full strong {
  font-style: normal;
  margin-bottom: 5px;
}

.signatures {
  flex: 1;
}

.signatures table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.signatures th, .signatures td {
  border: 1px solid #000;
  text-align: center;
  padding: 5px;
  vertical-align: bottom;
}

.description-sub {
  font-style: italic;
  padding-left: 10px;
  font-size: 11px;
  text-align: left;
}

@media print {
  body { margin:0; }
}
</style>
</head>
<body>

<h2>Purchase Requisition</h2>

<div class="header-info">
  <table>
    <tr>
      <td class="label">Request No</td>
      <td class="colon">:</td>
      <td class="value"><span id="requestNo"></span></td>
    </tr>
    <tr>
      <td class="label">Request Date</td>
      <td class="colon">:</td>
      <td class="value"><span id="requestDate"></span></td>
    </tr>
  </table>
</div>

<table class="items-table" id="itemsTable">
  <thead>
    <tr>
      <th>Description</th>
      <th>Qty</th>
      <th>Unit</th>
      <th>Notes</th>
      <th>Required Date</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="description-sign-container">
  <div class="description-full" id="descriptionContainer">
    <strong>Description:</strong>
    <span id="description"></span>
  </div>
  <div class="signatures">
    <table>
      <thead>
        <tr>
          <th>Dibuat</th>
          <th>Disetujui</th>
          <th>Diketahui</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyACOluEhfPw4JBlBaHyXtf1k3TIJAHikKo",
  authDomain: "inventory-gudang-16dfe.firebaseapp.com",
  projectId: "inventory-gudang-16dfe",
  storageBucket: "inventory-gudang-16dfe.appspot.com",
  messagingSenderId: "663364522026",
  appId: "1:663364522026:web:6ee9d76e506d6cf43eb289"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

async function loadPR(prNo){
  if(!prNo) { alert("PR No tidak ditemukan!"); return; }
  try {
    const snapshot = await db.collection("purchaseRequests")
      .where("header.request_no","==",prNo).limit(1).get();
    if(snapshot.empty){ alert("PR tidak ditemukan!"); return; }
    const doc = snapshot.docs[0];
    const prData = doc.data();
    const header = prData.header || {};
    const details = prData.details || [];

    document.getElementById("requestNo").textContent = header.request_no || '';
    document.getElementById("requestDate").textContent = header.request_date || '';
    document.getElementById("description").textContent = header.description || '';

    const tbody = document.querySelector("#itemsTable tbody");
    tbody.innerHTML = '';
    details.forEach(item=>{
      const mainDesc = item.description || '';
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${mainDesc}</td>
        <td class="center">${item.qty || 0}</td>
        <td class="center">${item.unit || ''}</td>
        <td class="center">${item.notes || ''}</td>
        <td class="required-date">${item.required_date || ''}</td>
      `;
      tbody.appendChild(row);

      if(item.style && item.style.toLowerCase().includes("eiger")){
        const additionalDesc = item.eiger_description || '';
        if(additionalDesc && additionalDesc !== mainDesc){
          const rowDesc = document.createElement("tr");
          rowDesc.innerHTML = `<td colspan="5" class="description-sub">${additionalDesc}</td>`;
          tbody.appendChild(rowDesc);
        }
      }
    });

    // Sesuaikan tinggi tanda tangan mengikuti Description
    const descriptionHeight = document.getElementById('descriptionContainer').offsetHeight;
    const signCells = document.querySelectorAll('.signatures td');
    signCells.forEach(td => {
      td.style.height = descriptionHeight + 'px';
    });

    window.print();
  } catch(e){ console.error(e); alert("Gagal memuat PR"); }
}

const prNoParam = getQueryParam('prno');
loadPR(prNoParam);
</script>
</body>
</html>
